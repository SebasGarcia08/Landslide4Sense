schema: '2.0'
stages:
  train:
    cmd: python stages/0_train.py
    deps:
    - path: ./data/train.txt
      md5: a830692ca38c3ec0344b34f80c62fd0a
      size: 105264
    - path: data/train.txt
      md5: a830692ca38c3ec0344b34f80c62fd0a
      size: 105264
    params:
      params.yaml:
        data:
          dir: ./data/
          train_list: data/train.txt
          eval_lists_paths:
          - ./data/train.txt
          eval_names:
          - train
          test_list: ./data/valid.txt
          input_size:
          - 128
          - 128
          augmentation:
            module: landslide4sense.data.augmentations
            name: transforms
        loss:
          module: torch.nn
          name: CrossEntropyLoss
          args:
            ignore_index: 255
        model:
          restore_from:
          module: landslide4sense.models
          name: Unet
          args:
            n_classes: 2
        optimizer:
          restore_from:
          module: torch.optim
          name: AdamW
          args:
            lr: 0.001
            weight_decay: 0.0005
          scheduler:
            module: torch_poly_lr_decay
            name: PolynomialLRDecay
            args:
              end_learning_rate: 1e-06
              max_decay_steps: 100000
              power: 0.9
        train:
          start_epoch: 0
          steps_per_epoch: 160
          batch_size: 100
          num_workers: 4
          num_steps: 100000
          num_steps_stop: 100000
          gpu_id: 0
          snapshot_dir: ./models/
          results_filename: train_results.json
          seed: 42
          callbacks:
            early_stopping:
              monitor: train_f1
              mode: max
              patience: 10
              best_result: 0.5
            wandb:
              project: landslide4sense
              name: back-to-basics
              group: segformer
              tags:
              - val_split
              - spatial_data_aug
              - non_spatial_data_aug
    outs:
    - path: ./models/back-to-basics/best_model.pth
      md5: b436551062619bfca7f267d2dcc1da7a
      size: 69175297
    - path: ./models/back-to-basics/ckpts
      md5: c73446483c02ae45dab7b4bcd7c11887.dir
      size: 415055520
      nfiles: 12
    - path: ./models/back-to-basics/train_results.json
      md5: 362f2099513af67d94cc7ebacafc9575
      size: 136
  calibrate:
    cmd: python stages/1_calibrate.py
    deps:
    - path: ./models/back-to-basics/best_model.pth
      md5: b436551062619bfca7f267d2dcc1da7a
      size: 69175297
    - path: ./models/back-to-basics/train_results.json
      md5: 362f2099513af67d94cc7ebacafc9575
      size: 136
    params:
      params.yaml:
        calibrate:
          model_filename: best_model.pth
          data_path: data/train.txt
          results_filename: calibrate_results.json
          num_thresholds: 100
    outs:
    - path: ./models/back-to-basics/calibrate_results.json
      md5: 1df417ca39c82811f98382e8782e827f
      size: 319
  predict:
    cmd: python stages/2_predict.py predict.snapshot_dir=./submissions/back-to-basics/
    deps:
    - path: ./models/back-to-basics/best_model.pth
      md5: b436551062619bfca7f267d2dcc1da7a
      size: 69175297
    - path: ./models/back-to-basics/calibrate_results.json
      md5: 1df417ca39c82811f98382e8782e827f
      size: 319
    params:
      params.yaml:
        predict:
          snapshot_dir: ./submissions/
    outs:
    - path: ./submissions/back-to-basics/
      md5: 3d8f18d241049bd6dabe9334747f1da1.dir
      size: 4515840
      nfiles: 245
  compress:
    cmd: cd ./submissions/back-to-basics/ && zip -rm ../back-to-basics.zip * && rm
      -rf back-to-basics/
    deps:
    - path: ./submissions/back-to-basics
      md5: d751713988987e9331980363e24189ce.dir
      size: 0
      nfiles: 0
    params:
      params.yaml:
        predict:
          snapshot_dir: ./submissions/
    outs:
    - path: ./submissions/back-to-basics.zip
      md5: d978980c660ef3e548c7f0448a31386a
      size: 122924
