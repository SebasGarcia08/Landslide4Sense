schema: '2.0'
stages:
  train:
    cmd: python stages/0_train.py
    deps:
    - path: ./data/train.txt
      md5: a830692ca38c3ec0344b34f80c62fd0a
      size: 105264
    - path: data/train.txt
      md5: a830692ca38c3ec0344b34f80c62fd0a
      size: 105264
    params:
      params.yaml:
        data:
          dir: ./data/
          train_list: data/train.txt
          eval_lists_paths:
          - ./data/train.txt
          eval_names:
          - train
          test_list: ./data/valid.txt
          input_size:
          - 128
          - 128
          augmentation:
            module: landslide4sense.data.augmentations
            name: transforms
        loss:
          module: torch.nn
          name: CrossEntropyLoss
          args:
            ignore_index: 255
        model:
          restore_from:
          module: landslide4sense.models
          name: SegFormer
          args:
            in_channels: 14
            num_classes: 2
            widths:
            - 64
            - 128
            - 256
            - 512
            depths:
            - 3
            - 4
            - 6
            - 3
            all_num_heads:
            - 1
            - 2
            - 4
            - 8
            patch_sizes:
            - 7
            - 3
            - 3
            - 3
            overlap_sizes:
            - 4
            - 2
            - 2
            - 2
            reduction_ratios:
            - 32
            - 16
            - 8
            - 4
            - 2
            - 1
            mlp_expansions:
            - 4
            - 4
            - 4
            - 4
            decoder_channels: 256
            scale_factors:
            - 16
            - 8
            - 4
            - 2
            - 1
        optimizer:
          restore_from:
          module: torch.optim
          name: AdamW
          args:
            lr: 0.0001
            weight_decay: 0.0001
          scheduler:
            module: torch_poly_lr_decay
            name: PolynomialLRDecay
            args:
              end_learning_rate: 1e-06
              max_decay_steps: 100000
              power: 0.9
        train:
          start_epoch: 0
          steps_per_epoch: 120
          batch_size: 32
          num_workers: 4
          num_steps: 100000
          num_steps_stop: 100000
          gpu_id: 0
          snapshot_dir: ./models/
          results_filename: train_results.json
          seed: 42
          callbacks:
            early_stopping:
              monitor: train_f1
              mode: max
              patience: 10
              best_result: 0.5
            wandb:
              project: landslide4sense
              name: seg-life-test
              group: segformer
              tags:
              - val_split
              - spatial_data_aug
              - non_spatial_data_aug
    outs:
    - path: ./models/seg-life-test/best_model.pth
      md5: f23d1282179aaef6603bd76840a33356
      size: 323057849
    - path: ./models/seg-life-test/ckpts
      md5: 855dd681fbaba6ae25f9bfe5a7c50320.dir
      size: 2584467776
      nfiles: 16
    - path: ./models/seg-life-test/train_results.json
      md5: 09cb55555696595cb08ded1bd8b33e28
      size: 135
  calibrate:
    cmd: python stages/1_calibrate.py
    deps:
    - path: ./models/seg-life-test/best_model.pth
      md5: f23d1282179aaef6603bd76840a33356
      size: 323057849
    - path: ./models/seg-life-test/train_results.json
      md5: 09cb55555696595cb08ded1bd8b33e28
      size: 135
    params:
      params.yaml:
        calibrate:
          model_filename: best_model.pth
          data_path: data/train.txt
          results_filename: calibrate_results.json
          num_thresholds: 100
    outs:
    - path: ./models/seg-life-test/calibrate_results.json
      md5: 7c1320eecb37fcc400500d0c701794b4
      size: 319
  predict:
    cmd: python stages/2_predict.py predict.snapshot_dir=./submissions/seg-life-test/
    deps:
    - path: ./models/seg-life-test/best_model.pth
      md5: f23d1282179aaef6603bd76840a33356
      size: 323057849
    - path: ./models/seg-life-test/calibrate_results.json
      md5: 7c1320eecb37fcc400500d0c701794b4
      size: 319
    params:
      params.yaml:
        predict:
          snapshot_dir: ./submissions/
    outs:
    - path: ./submissions/seg-life-test/
      md5: c30636ea00ede4d577d9714746ebcaf5.dir
      size: 4515840
      nfiles: 245
  compress:
    cmd: cd ./submissions/seg-life-test/ && zip -rm ../seg-life-test.zip * && rm -rf
      seg-life-test/
    deps:
    - path: ./submissions/seg-life-test
      md5: d751713988987e9331980363e24189ce.dir
      size: 0
      nfiles: 0
    params:
      params.yaml:
        predict:
          snapshot_dir: ./submissions/
    outs:
    - path: ./submissions/seg-life-test.zip
      md5: 6271a33c7a0e21425ed4c249ccc2427e
      size: 120773
